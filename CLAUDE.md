# GA4 Analytics API

Dockerized Python tool that queries the GA4 Data API and exports CSV reports. Two modes: single-property (ad-hoc) and multi-brand batch.

## Architecture

```
app/
  config.py    — Pydantic settings from GA4_* env vars (single-property mode)
  auth.py      — OAuth2 credential loading + auto-refresh from token.json
  report.py    — GA4 Data API query logic, handles metric chunking (10 max per request)
  export.py    — Timestamped CSV export
  main.py      — Single-property entrypoint (config -> auth -> query -> CSV)
  batch.py     — Multi-brand entrypoint (reads batch_config.json, loops brands x dates x reports)

scripts/
  authenticate.py  — Run on host (not Docker) to do OAuth browser flow -> credentials/token.json
  list_properties.py — Lists all GA4 property IDs via Admin API, outputs CSV to output/

credentials/
  client_secret.json  — OAuth client secret (from Google Cloud Console, gitignored)
  token.json          — OAuth token (generated by authenticate.py, gitignored)

batch_config.json  — Defines brands, date ranges, and report definitions for batch mode
.env               — GA4_* env vars for single-property mode (gitignored, see .env.example)
```

### Docker Services

- **ga4-report** — Single-property mode. Reads `.env` for config. Entrypoint: `python -m app.main`
- **ga4-batch** — Multi-brand batch mode. Bind-mounts `batch_config.json` at runtime. Entrypoint: `python -m app.batch`

## How to Add a New Brand

1. **Find the property ID** — Run the list script on the host:
   ```
   python scripts/list_properties.py
   ```
   This prints all GA4 properties across every account and saves a CSV to `output/ga4_properties_<timestamp>.csv`.

2. **Locate the brand** in the output and note its `property_id` (numeric).

3. **Add to batch_config.json** — Append a new entry to the `brands` array:
   ```json
   {
     "name": "Brand Name",
     "account_id": "123456789",
     "property_id": "987654321"
   }
   ```
   `account_id` can be empty string if unknown — only `property_id` is required for queries.

4. **Run batch to verify** — No rebuild needed; `ga4-batch` bind-mounts the config file:
   ```
   docker compose run --rm ga4-batch
   ```

## Running Reports

### Single-property (ad-hoc)
```bash
# Configure .env (see .env.example), then:
docker compose run --rm ga4-report
```
Output goes to `output/ga4_report_<timestamp>.csv`.

### Multi-brand batch
```bash
docker compose run --rm ga4-batch
```
Output goes to `output/batch/<report_name>_<timestamp>.csv` (one CSV per report type).

## Key Constraints

- **GA4 10-metric limit** — The API allows max 10 metrics per request. `report.py:chunk_metrics()` auto-splits larger lists and `batch.py` merges the results.
- **Rate limiting** — 1-second delay between API calls (`batch.py:REQUEST_DELAY_SECONDS`), doubled after errors.
- **Skipped brands** — Brands with `property_id` set to `"FILL_IN"` are filtered out at load time and logged as warnings.
- **Auth prerequisite** — `scripts/authenticate.py` must be run on the host (browser OAuth flow) before any Docker commands work. The resulting `credentials/token.json` is bind-mounted into containers.
